<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Quadruple Timer v8</title>

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<style>
  :root{
    --fg:#fff;
    --border:#23252b;
    --muted:rgba(255,255,255,.08);
    --muted2:rgba(255,255,255,.04);
    --nums-pause:#a855f7;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    font-family:Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
    -webkit-tap-highlight-color:transparent;
    background:#000;
    transition:background .18s ease;
    overflow-x:hidden;
  }

  /* Rising background bar */
  .progress-full{
    position:fixed; left:0; right:0; bottom:0; z-index:0;
    height:6vh;
    background:linear-gradient(to top, rgba(120,120,120,.55), rgba(120,120,120,.28));
    box-shadow:0 -10px 30px rgba(0,0,0,.30);
    pointer-events:none;
    transition:background .12s ease, box-shadow .12s ease, height .15s linear;
  }

  /* TOP-LEFT live device clock */
  .live-clock{
    position:fixed; top:8px; left:8px; z-index:12;
    font-size:32px; font-weight:1000; letter-spacing:.02em;
    background:var(--muted2); border:1px solid var(--border);
    padding:8px 14px; border-radius:999px;
  }
  @media (max-width:420px){ .live-clock{font-size:29px} }

  /* Info on the RIGHT */
  .info-right{
    position:fixed; top:52px; right:8px; z-index:12;
    background:var(--muted2); color:#bbb; border:1px solid var(--border);
    border-radius:999px; padding:6px 10px; font-size:12px; font-weight:800; cursor:pointer; user-select:none;
  }
  .info-right:active{transform:translateY(1px)}

  /* TOP-CENTER STOPWATCH */
  .stopwatch-top{
    position:fixed; top:8px; left:50%; transform:translateX(-50%);
    z-index:12; font-size:32px; font-weight:1000; letter-spacing:.02em;
    background:var(--muted2); border:1px solid var(--border);
    padding:8px 14px; border-radius:999px;
  }
  @media (max-width:420px){ .stopwatch-top{font-size:29px} }

  /* Settings-only Top Back (visible only while in-settings) */
  .settings-back-top{
    position:fixed; top:8px; right:8px; z-index:13;
    display:none; border:1px solid var(--border);
    background:var(--muted2); color:#fff; font-weight:900; font-size:14px;
    padding:10px 12px; border-radius:12px; cursor:pointer;
  }
  body.in-settings .settings-back-top{ display:inline-flex; }

  .app{
    position:relative; z-index:1; max-width:820px; margin:0 auto;
    min-height:100%; display:flex; flex-direction:column;
    padding:60px 12px 110px; gap:0;
  }

  /* Header with T1/T2/T3/T4 */
  .header{
    min-height:44px; display:flex; align-items:center; gap:10px;
    font-size:12px; color:#bbb; opacity:.95; padding:2px 0; flex-wrap:wrap;
  }
  .tag{
    position:relative;
    background:var(--muted2); border:1px solid var(--border);
    border-radius:999px; padding:6px 10px; display:flex; align-items:center; gap:6px;
    transition:background .15s ease, border-color .15s ease, color .15s ease;
  }
  .tag.active{
    background:rgba(255,255,255,.06);
    border-color:rgba(255,255,255,.25);
  }
  .tag.active::after{
    content:""; position:absolute; left:50%; transform:translateX(-50%);
    bottom:-6px; width:6px; height:6px; border-radius:50%;
    background:currentColor; opacity:.9;
  }
  .workrest{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .workrest.hidden{visibility:hidden;}

  /* Round counter pinned top-right; scales down after 100 */
  .top-right{ position:fixed; top:6px; right:8px; z-index:11; display:flex; align-items:center; gap:8px; }
  .rep-big{
    background:transparent; border:none; color:#fff; cursor:pointer; user-select:none;
    font-weight:1000; line-height:1; letter-spacing:.02em;
    font-size:44px; text-shadow:0 2px 10px rgba(0,0,0,.35);
  }
  .rep-big[data-len="3"]{ font-size:34px; }  /* 100–999 */
  .rep-big[data-len="4"]{ font-size:30px; }  /* 1000+  */
  .rep-big[data-len="5"]{ font-size:28px; }
  @media (orientation:portrait){
    .rep-big{ font-size:40px; }
    .rep-big[data-len="3"]{ font-size:30px; }
    .rep-big[data-len="4"]{ font-size:26px; }
    .rep-big[data-len="5"]{ font-size:24px; }
  }

  /* Center stage */
  .midwrap{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:0 6px; }
  .clockRow{ display:flex; align-items:center; gap:14px; }
  .clock{font-size:112px; font-weight:900; line-height:1; letter-spacing:.02em; margin:6px 0}
  .nav-btn{
    display:none; border:1px solid var(--border); background:var(--muted2);
    color:inherit; font-weight:900; font-size:18px; padding:10px 12px; border-radius:12px; cursor:pointer; user-select:none;
  }
  .nav-btn:active{transform:translateY(1px)}
  .phase{font-weight:900; letter-spacing:.08em; text-transform:uppercase; margin-top:10px}
  .pause-banner{
    margin-top:10px; font-size:36px; font-weight:1000; letter-spacing:.12em;
    text-transform:uppercase; color:var(--nums-pause); text-shadow:0 2px 14px rgba(0,0,0,.25);
    display:none;
  }

  /* Bottom controls */
  .bottom{ display:flex; flex-direction:column; gap:12px; align-items:center; margin:10px 0 0; }
  .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
    background:var(--muted2); border:1px solid var(--border); border-radius:999px; font-size:14px }
  .switch{position:relative; width:56px; height:32px; background:#333; border:1px solid var(--border); border-radius:999px; cursor:pointer}
  .switch input{display:none}
  .knob{position:absolute; top:2px; left:2px; width:28px; height:28px; border-radius:50%; background:#777; transition:all .18s ease}
  .switch input:checked + .knob{left:26px; background:#34d399}
  input[type="range"]{accent-color:#34d399}

  .btn{
    appearance:none; border:1px solid var(--border);
    background:var(--muted); color:rgba(255,255,255,.85);
    padding:12px 16px; border-radius:14px; font-weight:800; cursor:pointer; touch-action:manipulation;
    box-shadow:none;
  }
  .btn:hover{background:var(--muted2)}
  .btn:active{transform:translateY(1px)}
  .btn-xxl{font-size:22px; padding:14px 18px; border-radius:16px; min-width:150px}
  .btn.disabled{opacity:.45; filter:grayscale(.2); cursor:not-allowed}

  .settings{background:var(--muted2); border:1px solid var(--border); border-radius:14px; padding:10px 12px; width:100%; max-width:860px; max-height:48vh; overflow:auto;}
  h2{margin:4px 0 8px; font-size:16px; text-transform:uppercase; letter-spacing:.07em}
  .block{background:var(--muted); border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:8px}
  .digit-grid{display:grid; grid-template-columns:repeat(4, minmax(44px,1fr)); gap:8px; max-width:360px; margin:0 auto}
  .digit-box{display:flex; flex-direction:column; align-items:center; gap:6px}
  .digit{
    width:46px; height:58px; border-radius:10px; border:1px solid var(--border);
    background:var(--muted2); display:grid; place-items:center;
    font-size:26px; font-weight:900; color:var(--fg); cursor:pointer; user-select:none
  }
  .ud{display:flex; gap:6px}
  .ud button{
    width:46px; padding:8px 0; border-radius:10px; background:var(--muted);
    border:1px solid var(--border); color:var(--fg); font-weight:900; font-size:18px; touch-action:manipulation
  }
  .dlabel{font-size:11px; opacity:.8}

  .settings-inline-back{ display:none; align-items:center; gap:8px; margin:2px 0 8px; }
  body.in-settings .settings-inline-back{ display:flex; }

  /* Footer: ONLY "v8" */
  .footer{
    position:fixed; bottom:6px; right:8px; z-index:5;
    font-size:12px; opacity:.92; padding:6px 8px; background:var(--muted2);
    border:1px solid var(--border); border-radius:8px; line-height:1.25;
  }

  .transient{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:10px; z-index:6; background:var(--muted2); border:1px solid var(--border); color:#fff;
    padding:8px 12px; border-radius:10px; font-size:14px; opacity:0; pointer-events:none; transition:opacity .25s ease;
  }
  .transient.show{opacity:1}

  /* Hide rows when settings open */
  body.in-settings #actionRow,
  body.in-settings #audioRow,
  body.in-settings .nav-btn { display:none !important; }
</style>
</head>
<body>
  <!-- Rising bar -->
  <div id="progressFull" class="progress-full"></div>

  <!-- Mini chips -->
  <div class="live-clock" id="liveClock">00:00</div>
  <button id="openHelpRight" class="info-right" aria-label="Open instructions">ℹ️</button>
  <div class="stopwatch-top" id="stopwatchText">00:00</div>
  <button id="settingsBackTop" class="settings-back-top" title="Back to Timer">← Back</button>

  <div class="app" id="app">
    <div class="header">
      <span class="workrest" id="workRestHeader">
        <span id="t1Tag" class="tag">T1 <b id="t1Top">00:10</b></span>
        <span id="t2Tag" class="tag">T2 <b id="t2Top">00:40</b></span>
        <span id="t3Tag" class="tag">T3 <b id="t3Top">00:10</b></span>
        <span id="t4Tag" class="tag">T4 <b id="t4Top">00:00</b></span>
      </span>
    </div>

    <!-- Round -->
    <div class="top-right">
      <button id="roundBtn" class="rep-big" title="Tap: +1 round • Long-press: reset to 1">1</button>
    </div>

    <!-- CLOCK -->
    <div class="midwrap" id="timerArea">
      <div class="clockRow">
        <button id="backBtn" class="nav-btn" title="Back">⏪</button>
        <div class="clock" id="clock">00:10</div>
        <button id="fwdBtn" class="nav-btn" title="Forward">⏩</button>
      </div>
      <div class="phase" id="phase">Timer 1</div>
      <div class="pause-banner" id="pauseBanner">PAUSE</div>
    </div>

    <!-- Bottom controls -->
    <div class="bottom">
      <div class="row" id="actionRow">
        <button id="startBtn" class="btn btn-xxl" aria-pressed="false">▶️ Start / Pause</button>
        <button id="resetBtn" class="btn btn-xxl" title="Reset round to 1 • Go to Timer 1">⏹ Reset Round</button>
        <button class="btn btn-xxl" id="openSettings">⚙️ Settings</button>
      </div>

      <div class="settings-inline-back">
        <button class="btn" id="settingsBackInline" title="Back to Timer">↩️ Back</button>
      </div>

      <!-- Sound & Volume -->
      <div class="row" id="audioRow">
        <label class="chip" id="soundChip" title="Toggle all sounds">
          <span>Sound</span>
          <div class="switch">
            <input type="checkbox" id="soundToggle" checked />
            <div class="knob"></div>
          </div>
        </label>
        <label class="chip" id="volChip" title="Volume">
          <span>Vol</span>
          <input id="volume" type="range" min="0" max="100" value="70" />
        </label>
      </div>

      <!-- Settings -->
      <div class="settings" id="settingsBlock" hidden>
        <h2>Timer 1</h2>
        <div class="block">
          <div class="digit-grid" data-kind="t1">
            <div class="digit-box" data-role="mt"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Min (tens)</div></div>
            <div class="digit-box" data-role="mo"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Min (ones)</div></div>
            <div class="digit-box" data-role="st"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">1</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Sec (tens)</div></div>
            <div class="digit-box" data-role="so"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Sec (ones)</div></div>
          </div>
        </div>

        <h2>Timer 2</h2>
        <div class="block">
          <div class="digit-grid" data-kind="t2">
            <div class="digit-box" data-role="mt"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Min (tens)</div></div>
            <div class="digit-box" data-role="mo"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Min (ones)</div></div>
            <div class="digit-box" data-role="st"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">4</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Sec (tens)</div></div>
            <div class="digit-box" data-role="so"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Sec (ones)</div></div>
          </div>
        </div>

        <h2>Timer 3</h2>
        <div class="block">
          <div class="digit-grid" data-kind="t3">
            <div class="digit-box" data-role="mt"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Min (tens)</div></div>
            <div class="digit-box" data-role="mo"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Min (ones)</div></div>
            <div class="digit-box" data-role="st"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">1</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Sec (tens)</div></div>
            <div class="digit-box" data-role="so"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Sec (ones)</div></div>
          </div>
        </div>

        <h2>Timer 4</h2>
        <div class="block">
          <div class="digit-grid" data-kind="t4">
            <div class="digit-box" data-role="mt"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Min (tens)</div></div>
            <div class="digit-box" data-role="mo"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Min (ones)</div></div>
            <div class="digit-box" data-role="st"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Sec (tens)</div></div>
            <div class="digit-box" data-role="so"><div class="ud"><button data-act="inc">＋</button></div><div class="digit">0</div><div class="ud"><button data-act="dec">－</button></div><div class="dlabel">Sec (ones)</div></div>
          </div>
        </div>

        <!-- Sound options -->
        <div class="block">
          <label class="chip" style="gap:10px; cursor:pointer;">
            <input id="lowPitch" type="checkbox" style="width:18px;height:18px;"> <span>Low pitch</span>
          </label>
          <div class="dlabel">All beeps use a single pitch (high by default). Check to use low pitch.</div>
        </div>

        <div class="settings-cta">
          <button class="btn" id="settingsClose">↩️ Back</button>
          <button class="btn" id="settingsReset" title="Zero all • Reset round • Reset stopwatch">⏹ Reset</button>
        </div>
        <div class="dlabel" style="text-align:center; margin-top:6px;">Changes auto-save. Timers set to 0:00 are skipped.</div>
      </div>
    </div>

    <!-- HELP -->
    <section id="helpScreen" class="screen" style="display:none;">
      <div class="helpwrap" style="max-width:860px; margin:8px auto 120px; padding:0 8px;">
        <div class="help" style="background:var(--muted2); border:1px solid var(--border); border-radius:14px; padding:16px; font-size:14px; line-height:1.5; color:#ddd;">
          <h3>How it works</h3>
          <ul style="margin:6px 0 0 18px">
            <li>Tap main timer to Start / Pause / Resume.</li>
            <li>Reset Round: round=1, stopwatch reset, go to Timer 1 (paused).</li>
            <li>Any timer set to <b>0:00</b> is skipped.</li>
            <li>Defaults: T1 0:10, T2 0:40, T3 0:10, T4 0:00.</li>
            <li><button class="btn" id="backFromHelp">← Back</button></li>
          </ul>
        </div>
      </div>
    </section>
  </div>

  <!-- Version badge -->
  <div class="footer" id="footerBadge">v8</div>

  <!-- Transient toast -->
  <div class="transient" id="toast"></div>

<script>
  /* ------- Minimal PWA manifest ------- */
  (function addManifest(){
    const manifest = {
      name:"Quadruple Timer", short_name:"QuadTimer", start_url:"./", display:"standalone",
      theme_color:"#000000", background_color:"#000000", icons:[]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
  })();

  /* Fullscreen on first interaction */
  let triedFS=false;
  function tryFS(){ if(triedFS) return; triedFS=true;
    const el=document.documentElement;
    (el.requestFullscreen?.bind(el) || el.webkitRequestFullscreen?.bind(el) || (()=>Promise.resolve()))().catch(()=>{});
  }
  document.addEventListener('pointerdown', tryFS, {once:true});

  /* Utils */
  const $ = id => document.getElementById(id);
  const qs = (s, r=document) => r.querySelector(s);
  const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
  const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
  const pad = n => String(n).padStart(2,'0');
  const fmt = secs => { secs=Math.max(0,Math.round(secs));
    const h=Math.floor(secs/3600), m=Math.floor((secs%3600)/60), s=secs%60;
    return h>0 ? `${h}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`; };

  function fmtHHMM(d){ return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function tickLiveClock(){ $('liveClock').textContent = fmtHHMM(new Date()); }
  setInterval(tickLiveClock, 1000); tickLiveClock();

  function showToast(msg, ms=2000){
    const el = $('toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{ el.classList.remove('show'); }, ms);
  }

  /* ---------- COLOR SCHEME (per timer) ---------- */
  const styles = [
    /* T1: Blue number • Grey-blue bg • Blue bargraph */
    { name:'Timer 1', bg:'#1e293b', num:'#60a5fa',
      bar1:'rgba(37,99,235,.55)', bar2:'rgba(37,99,235,.24)' },

    /* T2: Bright Yellow number • Grey-yellow bg • Dark Red bargraph */
    { name:'Timer 2', bg:'#3a3a1f', num:'#fde047',
      bar1:'rgba(185,28,28,.55)', bar2:'rgba(185,28,28,.24)' },

    /* T3: Bright Red number • Grey-pink bg • Blue bargraph (slightly brighter) */
    { name:'Timer 3', bg:'#3a2a34', num:'#ef4444',
      bar1:'rgba(59,130,246,.58)', bar2:'rgba(59,130,246,.30)' },

    /* T4: Bright Green number • Grey-green bg • Dark Red bargraph */
    { name:'Timer 4', bg:'#22322a', num:'#22c55e',
      bar1:'rgba(153,27,27,.55)', bar2:'rgba(153,27,27,.24)' }
  ];

  /* ---------- STATE ---------- */
  const state = {
    timers: [10,40,10,0],     // defaults
    idx: 0,
    running:false,
    startTs:0, elapsed:0,
    round:1,
    muted:false, volume:0.7,
    lowPitch:false,           // single pitch selector
    swElapsed:0, swLastStart:0
  };

  /* Persistence */
  (function load(){
    try{
      const saved = JSON.parse(localStorage.getItem('quad_v1')||'{}');
      ['timers','idx','round','muted','volume','swElapsed','lowPitch'].forEach(k=>{
        if(saved[k]!==undefined){
          if(k==='muted' || k==='lowPitch') state[k]=!!saved[k];
          else if(k==='volume') state[k]=+saved[k];
          else if(k==='timers') state[k]=Array.isArray(saved[k])?saved[k].map(x=>+x||0):state[k];
          else state[k]= +saved[k];
        }
      });
      state.idx = Math.min(3, Math.max(0, state.idx|0));
    }catch{}
  })();
  function persist(){
    localStorage.setItem('quad_v1', JSON.stringify({
      timers:state.timers, idx:state.idx, round:state.round,
      muted:state.muted, volume:state.volume, swElapsed:state.swElapsed,
      lowPitch:state.lowPitch
    }));
  }

  /* Elements */
  const progressFull = $('progressFull');
  const t1Top = $('t1Top'), t2Top = $('t2Top'), t3Top = $('t3Top'), t4Top = $('t4Top');
  const t1Tag = $('t1Tag'), t2Tag = $('t2Tag'), t3Tag = $('t3Tag'), t4Tag = $('t4Tag');
  const stopwatchText = $('stopwatchText');
  const pauseBanner = $('pauseBanner');
  const clockEl = $('clock');
  const phaseEl = $('phase');
  const roundBtn = $('roundBtn');
  const startBtn = $('startBtn');
  const resetBtn = $('resetBtn');
  const openSettingsBtn = $('openSettings');
  const settingsBlock = $('settingsBlock');
  const settingsClose = $('settingsClose');
  const settingsBackTop = $('settingsBackTop');
  const settingsBackInline = $('settingsBackInline');
  const settingsReset = $('settingsReset');
  const soundToggle = $('soundToggle');
  const volumeInput = $('volume');
  const backBtn = $('backBtn');
  const fwdBtn  = $('fwdBtn');
  const openHelpRight = $('openHelpRight');
  const workRestHeader = $('workRestHeader');
  const lowPitchChk = $('lowPitch');

  /* Audio toggles */
  soundToggle.checked = !state.muted;
  volumeInput.value = Math.round(state.volume*100);
  lowPitchChk.checked = !!state.lowPitch;
  soundToggle.addEventListener('change', ()=>{ state.muted = !soundToggle.checked; persist(); });
  volumeInput.addEventListener('input', ()=>{ state.volume = clamp(+volumeInput.value/100,0,1); persist(); });
  lowPitchChk.addEventListener('change', ()=>{ state.lowPitch = lowPitchChk.checked; persist(); });

  /* Helpers */
  const BEAT = 60/105; // 105 bpm

  function secsToParts(s){ s=Math.max(0,Math.round(s)); return {m:Math.floor(s/60), s:s%60}; }
  function setTopTimes(){
    const ps = state.timers.map(secsToParts);
    t1Top.textContent = `${pad(ps[0].m)}:${pad(ps[0].s)}`;
    t2Top.textContent = `${pad(ps[1].m)}:${pad(ps[1].s)}`;
    t3Top.textContent = `${pad(ps[2].m)}:${pad(ps[2].s)}`;
    t4Top.textContent = `${pad(ps[3].m)}:${pad(ps[3].s)}`;
    const r = String(state.round);
    roundBtn.textContent = r;
    roundBtn.setAttribute('data-len', r.length);
    const numCol = styles[state.idx].num;
    workRestHeader.style.color = numCol;
    [t1Tag,t2Tag,t3Tag,t4Tag].forEach((el,i)=>{ el.classList.toggle('active', i===state.idx); });
  }
  function currentTotal(){ return state.timers[state.idx]|0; }
  function remainingSeconds(){ return Math.max(0, Math.round(currentTotal() - state.elapsed)); }

  function applyStyle(){
    const st = styles[state.idx];
    document.body.style.background = st.bg;
    const numCol = st.num;
    clockEl.style.color = numCol;
    phaseEl.style.color = numCol;
    stopwatchText.style.color = numCol;
    $('liveClock').style.color = numCol;
    roundBtn.style.color = numCol;
    progressFull.style.background = `linear-gradient(to top, ${st.bar1}, ${st.bar2})`;
    progressFull.style.boxShadow = `0 -10px 30px ${st.bar1.replace(/,\.?\d+\)/,',.28)').replace('rgba','rgba')}`;
  }

  function updateProgress(){
    const total=currentTotal();
    const frac = total>0 ? Math.min(state.elapsed/total,1) : 1;
    const minVH=6;
    progressFull.style.height = (Math.max(minVH, frac*100)).toFixed(2)+'vh';
  }

  function updateStopwatch(){
    let sw = state.swElapsed;
    if(state.running && state.swLastStart){ sw += (performance.now()-state.swLastStart)/1000; }
    stopwatchText.textContent = fmt(sw);
  }

  function updatePlayPauseVisibility(){
    const playing = state.running;
    const inSettings = document.body.classList.contains('in-settings');
    $('actionRow').style.display = (playing || inSettings) ? 'none' : '';
    $('audioRow').style.display  = (playing || inSettings) ? 'none' : '';
    const showNav = (!state.running) && !inSettings;
    backBtn.style.display = showNav ? 'inline-flex' : 'none';
    fwdBtn.style.display  = showNav ? 'inline-flex' : 'none';
    pauseBanner.style.display = (!state.running && state.elapsed>0) ? 'block' : 'none';
  }

  function updateAllUI(){
    phaseEl.textContent = styles[state.idx].name;
    clockEl.textContent = fmt(remainingSeconds());
    setTopTimes();
    updateProgress();
    applyStyle();
    updateStopwatch();
    updatePlayPauseVisibility();
    startBtn.classList.toggle('active', state.running);
    startBtn.setAttribute('aria-pressed', String(state.running));
  }

  /* Settings digits */
  function populateDigits(kind, secs){
    const grid = qs(`.digit-grid[data-kind="${kind}"]`);
    const {m,s} = secsToParts(secs);
    const mt=Math.floor(m/10), mo=m%10, st=Math.floor(s/10), so=s%10;
    const map={mt,mo,st,so};
    qsa('.digit-box',grid).forEach(b=>{ qs('.digit',b).textContent = map[b.dataset.role]; });
  }
  function readDigits(kind){
    const grid = qs(`.digit-grid[data-kind="${kind}"]`);
    const mt=+qs('[data-role="mt"] .digit',grid).textContent;
    const mo=+qs('[data-role="mo"] .digit',grid).textContent;
    const st=+qs('[data-role="st"] .digit',grid).textContent;
    const so=+qs('[data-role="so"] .digit',grid).textContent;
    return (mt*10+mo)*60 + (st*10+so);
  }
  function commitDigits(kind){
    const idx = ({t1:0,t2:1,t3:2,t4:3})[kind];
    if(idx==null) return;
    const secs = readDigits(kind);
    state.timers[idx] = secs;
    persist(); setTopTimes(); updateAllUI();
  }
  ['t1','t2','t3','t4'].forEach(kind=>{
    const gridSel = `.digit-grid[data-kind="${kind}"]`;
    document.addEventListener('click', (e)=>{
      const grid = qs(gridSel);
      if(!grid || !grid.contains(e.target)) return;
      const box = e.target.closest('.digit-box'); if(!box) return;
      const digitEl = qs('.digit', box);

      if(e.target===digitEl){
        const v = prompt('Enter a digit (0–9):', digitEl.textContent);
        if(v==null) return; const d=Number(v.trim());
        if(Number.isInteger(d) && d>=0 && d<=9){
          const role=box.dataset.role; const max=(role==='mt'||role==='st')?5:9;
          digitEl.textContent = String(Math.min(max, Math.max(0,d)));
          commitDigits(kind);
        }
      }
      const act = e.target.closest('button[data-act]');
      if(act){
        const role=box.dataset.role; let cur=+digitEl.textContent; const inc=act.dataset.act==='inc';
        const max=(role==='mt'||role==='st')?5:9, min=0;
        cur = inc?cur+1:cur-1; if(cur>max)cur=min; if(cur<min)cur=max;
        digitEl.textContent=String(cur);
        commitDigits(kind);
      }
    });
  });

  /* ---------- AUDIO ---------- */
  let rafId=null;
  let audioCtx=null;
  function ensureAudio(){
    if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    if(audioCtx.state==='suspended'){ audioCtx.resume(); }
  }
  function oscBeep(freq=700, dur=0.26, t0){
    if(state.muted) return 0;
    const ctx=audioCtx||(audioCtx=new (window.AudioContext||window.webkitAudioContext)());
    const now = t0 ?? ctx.currentTime;
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.type='sine';
    osc.frequency.setValueAtTime(freq, now);
    const peak = state.volume * 0.85;
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(Math.max(0.0002, peak), now+0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, now+dur);
    osc.connect(gain).connect(ctx.destination);
    osc.start(now);
    osc.stop(now+dur+0.02);
    return dur;
  }
  const HIGH_PITCH = 780;   // single pitch (default)
  const LOW_PITCH  = 520;   // optional low pitch
  function pitch(){ return state.lowPitch ? LOW_PITCH : HIGH_PITCH; }

  function scheduleBeeps(times){
    // times: array of {t:Number, dur:Number}
    ensureAudio();
    const ctx=audioCtx;
    const base=ctx.currentTime;
    const f = pitch();
    times.forEach(b=>{
      const t = base + (b.t || 0);
      const d = b.dur ?? 0.24;
      oscBeep(f, d, t);
    });
  }

  /* Patterns (single pitch for all) */
  const BEAT = 60/105; // already defined above; keep once if minified
  function cueStep(){
    if(state.muted) return;
    switch(state.idx){
      case 0: scheduleBeeps([{t:0, dur:0.28}]); break;                                       // T1: 1 beep
      case 1: scheduleBeeps([{t:0, dur:0.22},{t:BEAT, dur:0.22}]); break;                    // T2: 2 beeps
      case 2: scheduleBeeps([{t:0, dur:0.20},{t:BEAT, dur:0.20},{t:BEAT+0.24, dur:0.34}]); break; // T3: da da-Da
      case 3: scheduleBeeps([{t:0, dur:0.18},{t:0.20, dur:0.24},{t:0.20+BEAT, dur:0.18},{t:0.20+BEAT+0.20, dur:0.24}]); break; // T4
    }
  }

  /* ---------- NAV HELPERS (skip 0:00 timers) ---------- */
  function hasAnyNonZero(){
    return state.timers.some(t=> (t|0) > 0 );
  }
  function nextNonZeroIndex(from){
    for(let k=1;k<=4;k++){
      const ni = (from + k) % 4;
      if((state.timers[ni]|0) > 0) return ni;
    }
    return from;
  }
  function prevNonZeroIndex(from){
    for(let k=1;k<=4;k++){
      const pi = (from - k + 4) % 4;
      if((state.timers[pi]|0) > 0) return pi;
    }
    return from;
  }

  /* ---------- ENGINE ---------- */
  function start(){
    if(!hasAnyNonZero()){ showToast('All timers are 0:00'); return; }
    if(currentTotal()===0){
      const ni = nextNonZeroIndex(state.idx);
      state.idx = ni; state.elapsed = 0;
    }
    if(state.running) return;
    ensureAudio();
    state.running=true;
    state.startTs = performance.now() - state.elapsed*1000;
    state.swLastStart = performance.now();
    if(state.elapsed===0){ cueStep(); }
    loop(); updateAllUI();
  }
  function pause(){
    if(!state.running) return;
    state.running=false;
    if(rafId) cancelAnimationFrame(rafId); rafId=null;
    if(state.swLastStart){
      state.swElapsed += (performance.now()-state.swLastStart)/1000;
      state.swLastStart=0; persist();
    }
    updateAllUI();
  }
  function toggleStartPause(){ state.running?pause():start(); }

  function advanceIndexAuto(){
    const prevIdx = state.idx;
    const nextIdx = nextNonZeroIndex(prevIdx);
    state.idx = nextIdx;
    if(nextIdx <= prevIdx) { state.round += 1; }
    state.elapsed=0; state.startTs=performance.now(); cueStep(); persist(); updateAllUI();
  }

  function loop(){
    if(!state.running) return;
    const total=currentTotal();
    const now=performance.now();
    state.elapsed = Math.max(0,(now-state.startTs)/1000);

    updateStopwatch();
    if(total===0 || state.elapsed>=total){ advanceIndexAuto(); }
    updateAllUI();
    rafId=requestAnimationFrame(loop);
  }

  /* ---------- INTERACTIONS ---------- */
  let tapCount=0, tapTimer=null;
  function commitTap(){ const c=tapCount; tapCount=0; clearTimeout(tapTimer); tapTimer=null; if(c===1) toggleStartPause(); }
  $('timerArea').addEventListener('pointerdown', (e)=>{
    if(document.body.classList.contains('in-settings')) return;
    if(e.target.closest('button, input, label, .digit, .ud button, .settings')) return;
    tapCount+=1; if(tapTimer) clearTimeout(tapTimer); tapTimer=setTimeout(commitTap, 250);
  });

  $('startBtn').addEventListener('click', (e)=>{ e.stopPropagation(); toggleStartPause(); });
  resetBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    state.round=1; state.swElapsed=0;
    state.swLastStart = state.running?performance.now():0;
    state.idx=0; state.elapsed=0; persist(); updateAllUI();
    showToast('Round reset • Stopwatch reset • Set to Timer 1');
  });

  function openSettings(){
    pause();
    settingsBlock.hidden=false;
    document.body.classList.add('in-settings');
    populateDigits('t1',state.timers[0]);
    populateDigits('t2',state.timers[1]);
    populateDigits('t3',state.timers[2]);
    populateDigits('t4',state.timers[3]);
    lowPitchChk.checked = !!state.lowPitch;
    updateAllUI();
  }
  function closeSettings(){
    settingsBlock.hidden=true;
    document.body.classList.remove('in-settings');
    updateAllUI();
  }
  openSettingsBtn.addEventListener('click', openSettings);
  settingsClose?.addEventListener('click', closeSettings);
  settingsBackTop.addEventListener('click', closeSettings);
  settingsBackInline.addEventListener('click', closeSettings);

  openHelpRight.addEventListener('click', ()=>{ $('helpScreen').style.display='block'; });
  $('backFromHelp')?.addEventListener('click', ()=>{ $('helpScreen').style.display='none'; });

  // Round button: +1 tap, long-press reset to 1
  let repPressTimer=null, repPressed=false;
  roundBtn.addEventListener('pointerdown', ()=>{
    repPressed=true;
    repPressTimer=setTimeout(()=>{ if(repPressed){ state.round=1; persist(); updateAllUI(); showToast('Round reset to 1'); } }, 500);
  });
  roundBtn.addEventListener('pointerup', ()=>{
    if(repPressTimer){ clearTimeout(repPressTimer); repPressTimer=null; }
    if(repPressed){ state.round+=1; persist(); updateAllUI(); }
    repPressed=false;
  });
  roundBtn.addEventListener('pointerleave', ()=>{ repPressed=false; if(repPressTimer){ clearTimeout(repPressTimer); repPressTimer=null; } });

  document.addEventListener('keydown', (e)=>{
    const tag=(e.target&&e.target.tagName)?e.target.tagName.toUpperCase():'';
    if(tag==='INPUT'||tag==='TEXTAREA'||e.target.isContentEditable) return;
    if($('helpScreen').style.display==='block') return;
    if(document.body.classList.contains('in-settings')) return;
    toggleStartPause();
  });

  settingsReset.addEventListener('click', ()=>{
    pause();
    state.timers=[0,0,0,0]; state.round=1; state.swElapsed=0; state.swLastStart=0; state.idx=0; persist();
    populateDigits('t1',0); populateDigits('t2',0); populateDigits('t3',0); populateDigits('t4',0);
    setTopTimes(); updateAllUI();
    showToast('All zeroed • Round reset • Stopwatch reset • Set to Timer 1');
  });

  /* ---------- NEW: Pause-mode back/forward semantics ---------- */
  function restartCurrentPaused(){
    state.elapsed = 0;
    state.startTs = performance.now();
    updateAllUI();
  }

  backBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(state.running || document.body.classList.contains('in-settings')) return;

    // First press: restart current if not already at 0
    if(state.elapsed > 0){
      restartCurrentPaused();
      return;
    }

    // Already at start of current timer
    if(!hasAnyNonZero()){ return; }

    // If we're at T1 and round==1, clamp
    if(state.idx === 0 && state.round === 1){
      restartCurrentPaused();
      return;
    }

    // Move to previous non-zero timer, possibly previous round
    const prevIdx = prevNonZeroIndex(state.idx);
    if(prevIdx === state.idx){
      // only T?=0:00 present; nothing to move
      restartCurrentPaused();
      return;
    }
    // If wrapping T1 -> T4, reduce round (unless already at 1, which we handled)
    if(prevIdx > state.idx){
      state.round = Math.max(1, state.round - 1);
    }
    state.idx = prevIdx;
    restartCurrentPaused();
    persist();
  });

  fwdBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(state.running || document.body.classList.contains('in-settings')) return;

    // First press: restart current if not already at 0
    if(state.elapsed > 0){
      restartCurrentPaused();
      return;
    }

    if(!hasAnyNonZero()){ return; }

    // Move to next non-zero timer; if wrap T4->T1, increase round
    const nextIdx = nextNonZeroIndex(state.idx);
    if(nextIdx === state.idx){
      restartCurrentPaused();
      return;
    }
    if(nextIdx < state.idx){
      state.round += 1;
    }
    state.idx = nextIdx;
    restartCurrentPaused();
    persist();
  });

  /* Init */
  (function init(){
    setTopTimes();
    if(currentTotal()===0 && hasAnyNonZero()){
      const ni = nextNonZeroIndex(state.idx);
      state.idx = ni;
    }
    clockEl.textContent = fmt(currentTotal());
    const total=currentTotal(), frac = total>0?Math.min(state.elapsed/total,1):0;
    progressFull.style.height=(Math.max(6,frac*100)).toFixed(2)+'vh';
    updateStopwatch(); updateAllUI();
  })();

  /* Keep screen awake */
  if('wakeLock' in navigator){
    let wl;
    const req=async()=>{try{wl=await navigator.wakeLock.request('screen');}catch{}};
    req();
    document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') req(); });
  }
</script>
</body>
</html>
