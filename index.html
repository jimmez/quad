<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Quad Timer v17</title>
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<style>
:root{
  --fg:#fff; --border:#23252b; --muted:rgba(255,255,255,.08); --muted2:rgba(255,255,255,.04);
  --t1-num:#60a5fa; --t1-bg:#0b1420; --t1-bar:#1b6ad8;
  --t2-num:#facc15; --t2-bg:#2a2320; --t2-bar:#7a1111;
  --t3-num:#ef4444; --t3-bg:#2a1e25; --t3-bar:#163a8c;
  --t4-num:#22c55e; --t4-bg:#17231b; --t4-bar:#7a1111;
  --pause-num:#a855f7;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;color:var(--fg);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#000;transition:background .18s ease;overflow-x:hidden}
.app{position:relative;z-index:1;max-width:980px;margin:0 auto;min-height:100%;display:flex;flex-direction:column;padding:60px 12px 120px}
/* top chips */
.live-clock,.stopwatch{position:fixed;top:8px;z-index:12;font-size:28px;font-weight:1000;letter-spacing:.02em;background:var(--muted2);border:1px solid var(--border);padding:8px 14px;border-radius:999px}
.live-clock{left:8px}
.stopwatch{left:50%;transform:translateX(-50%)}
@media (max-width:420px){.live-clock,.stopwatch{font-size:26px}}
.help-btn{position:fixed;left:8px;bottom:8px;z-index:14;background:var(--muted2);border:1px solid var(--border);color:#fff;font-weight:900;font-size:16px;padding:8px 12px;border-radius:12px;display:none}
/* header tags */
.header{height:44px;display:flex;align-items:center;gap:8px;font-size:12px;color:#bbb;opacity:.95;padding:2px 0}
.tag{background:var(--muted2);border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:flex;gap:6px;align-items:center}
/* main clock */
.mid{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
.clockRow{display:flex;align-items:center;gap:14px}
.clock{font-size:110px;font-weight:900;line-height:1;letter-spacing:.02em;margin:6px 0}
.nav-btn{display:none;border:1px solid var(--border);background:var(--muted2);color:#fff;font-weight:900;font-size:18px;padding:10px 12px;border-radius:12px;cursor:pointer}
.phase{font-weight:900;letter-spacing:.08em;text-transform:uppercase;margin-top:10px}
.pause-banner{margin-top:8px;font-size:32px;font-weight:1000;letter-spacing:.12em;text-transform:uppercase;color:var(--pause-num);display:none}
/* rising bar */
.progress-full{position:fixed;left:0;right:0;bottom:0;z-index:0;height:6vh;background:linear-gradient(to top,#1b6ad8,#1b6ad8);box-shadow:0 -10px 30px rgba(0,0,0,.25);transition:height .15s linear}
/* bottom rows */
.row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
.btn{appearance:none;border:1px solid var(--border);background:var(--muted);color:rgba(255,255,255,.9);padding:12px 16px;border-radius:14px;font-weight:800;cursor:pointer}
.btn-xxl{font-size:22px;padding:14px 18px;border-radius:16px;min-width:150px}
/* settings panel */
.settings{background:var(--muted2);border:1px solid var(--border);border-radius:14px;padding:10px 12px;width:100%;max-width:980px;max-height:50vh;overflow:auto}
h2{margin:6px 0 8px;font-size:16px;text-transform:uppercase;letter-spacing:.07em}
.block{background:var(--muted);border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(120px,1fr));gap:8px}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:var(--muted2);border:1px solid var(--border);border-radius:999px;font-size:14px}
.switch{position:relative;width:56px;height:32px;background:#333;border:1px solid var(--border);border-radius:999px;cursor:pointer}
.switch input{display:none}
.knob{position:absolute;top:2px;left:2px;width:28px;height:28px;border-radius:50%;background:#777;transition:all .18s ease}
.switch input:checked + .knob{left:26px;background:#34d399}
input[type="range"]{accent-color:#34d399}
select, input[type="text"], input[type="url"], input[type="number"]{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0b0b0b;color:#fff}
.small{font-size:12px;opacity:.85}
/* playlist manager */
.pm-row{display:grid;grid-template-columns:120px 1fr auto auto;gap:8px;align-items:center;margin-bottom:8px}
.use-btn{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#1b1b1b;color:#eee;cursor:pointer}
.use-btn.active{background:#14532d;box-shadow:0 0 0 2px rgba(34,197,94,.35) inset}
.clear-btn{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#281818;color:#fca5a5;cursor:pointer}
/* overlays */
.lock-overlay{position:fixed;inset:0;z-index:20;background:transparent;display:none}
.lock-overlay.dim60{background:rgba(0,0,0,.6)}
.lock-overlay.dim80{background:rgba(0,0,0,.8)}
.lock-overlay.dim100{background:rgba(0,0,0,1)}
.lock-msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:900;letter-spacing:.06em;background:rgba(0,0,0,.35);padding:10px 14px;border-radius:12px;border:1px solid var(--border);display:none}
/* yt floating */
#ytFloat{position:fixed;right:10px;bottom:10px;width:320px;height:180px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#000;z-index:11;display:none}
#ytFloatHeader{display:flex;justify-content:space-between;align-items:center;background:#111;padding:6px 8px;font-size:12px}
#ytFloatBody{width:100%;height:calc(100% - 28px)}
/* help */
#helpCard{position:fixed;left:8px;bottom:52px;z-index:15;max-width:420px;background:#0d0d0d;border:1px solid var(--border);border-radius:12px;padding:10px;display:none}
#helpCard h3{margin:0 0 6px;font-size:16px}
#helpCard ul{margin:6px 0 0 18px}
/* footer */
.footer{position:fixed;bottom:6px;right:8px;text-align:right;font-size:12px;opacity:.92;padding:6px 8px;background:var(--muted2);border:1px solid var(--border);border-radius:8px;z-index:5}
/* splash */
.transient{position:fixed;left:50%;transform:translateX(-50%);bottom:10px;z-index:6;background:var(--muted2);border:1px solid var(--border);color:#fff;padding:8px 12px;border-radius:10px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .25s ease}
.transient.show{opacity:1}
/* state-driven visuals */
body.t1 .clock{color:var(--t1-num)} body.t1{background:var(--t1-bg)}
body.t2 .clock{color:var(--t2-num)} body.t2{background:var(--t2-bg)}
body.t3 .clock{color:var(--t3-num)} body.t3{background:var(--t3-bg)}
body.t4 .clock{color:var(--t4-num)} body.t4{background:var(--t4-bg)}
body.paused .clock{color:var(--pause-num)}
/* show help only when paused */
body.paused .help-btn{display:inline-flex}
/* hide rows while playing or settings open */
body.playing .hide-on-play{display:none}
body.in-settings .hide-when-settings{display:none}
@media (max-width:420px){.clock{font-size:96px} .btn-xxl{min-width:140px}}
</style>
</head>
<body class="t1 paused">
<div id="progressFull" class="progress-full"></div>

<div class="live-clock" id="liveClock">00:00</div>
<div class="stopwatch" id="stopwatch">00:00</div>

<button id="helpBtn" class="help-btn">?</button>
<div id="helpCard">
  <h3>Help</h3>
  <ul class="small">
    <li>Tap main timer to Start/Pause. Forward/Back jump T1â†’T4.</li>
    <li>T1 (30s) controls Spotify. T2 (20s) controls YouTube.</li>
    <li>Show Video reveals embedded YouTube. Hidden still plays.</li>
    <li>Next Video/Next Chapter work even when hidden.</li>
    <li>Lock Screen blocks touch (double-tap to unlock). Dim level in Settings.</li>
  </ul>
</div>

<div class="app">
  <div class="header">
    <span class="tag">T1 <b id="t1Goal">00:30</b></span>
    <span class="tag">T2 <b id="t2Goal">00:20</b></span>
    <span class="tag">T3 <b id="t3Goal">00:00</b></span>
    <span class="tag">T4 <b id="t4Goal">00:00</b></span>
  </div>

  <div class="mid" id="timerArea">
    <div class="clockRow">
      <button id="backBtn" class="nav-btn">âª</button>
      <div class="clock" id="clock">00:30</div>
      <button id="fwdBtn" class="nav-btn">â©</button>
    </div>
    <div class="phase" id="phase">T1</div>
    <div class="pause-banner" id="pauseBanner">PAUSE</div>
  </div>

  <div class="row hide-when-settings hide-on-play" id="actionRow">
    <button id="startBtn" class="btn btn-xxl" aria-pressed="false">â–¶ï¸ Start / Pause</button>
    <button id="openSettings" class="btn btn-xxl">âš™ï¸ Settings</button>
  </div>

  <div class="settings" id="settings" hidden>
    <div class="block grid2">
      <div>
        <label class="small">T1 (sec)</label>
        <input id="t1Input" type="number" min="0" value="30">
      </div>
      <div>
        <label class="small">T2 (sec)</label>
        <input id="t2Input" type="number" min="0" value="20">
      </div>
      <div>
        <label class="small">T3 (sec)</label>
        <input id="t3Input" type="number" min="0" value="0">
      </div>
      <div>
        <label class="small">T4 (sec)</label>
        <input id="t4Input" type="number" min="0" value="0">
      </div>
      <div>
        <label class="small">Keep Screen Awake</label>
        <label class="chip"><span>On/Off</span>
          <div class="switch"><input id="wakeToggle" type="checkbox" checked><div class="knob"></div></div>
        </label>
      </div>
      <div>
        <label class="small">Lock Screen (double-tap to unlock)</label>
        <label class="chip"><span>On/Off</span>
          <div class="switch"><input id="lockToggle" type="checkbox"><div class="knob"></div></div>
        </label>
        <div style="margin-top:6px" class="small">
          Dim Screen:
          <label><input type="radio" name="dim" value="off" checked> Off</label>
          <label><input type="radio" name="dim" value="60"> 60%</label>
          <label><input type="radio" name="dim" value="80"> 80%</label>
          <label><input type="radio" name="dim" value="100"> 100%</label>
        </div>
      </div>
    </div>

    <h2>Spotify</h2>
    <div class="block">
      <div class="small">User: <b>jimmez68</b>. Connect then select which timers control Spotify (default: T1).</div>
      <div style="margin:8px 0;display:flex;gap:8px;flex-wrap:wrap">
        <button id="spConnect" class="btn">ðŸ”— Connect Spotify</button>
        <label class="chip"><input id="spT1" type="checkbox" checked> T1</label>
        <label class="chip"><input id="spT2" type="checkbox"> T2</label>
        <label class="chip"><input id="spT3" type="checkbox"> T3</label>
        <label class="chip"><input id="spT4" type="checkbox"> T4</label>
      </div>
    </div>

    <h2>YouTube</h2>
    <div class="block">
      <div class="small" style="margin-bottom:6px">Default: T2 active, Shuffle ON, Next Track ON. Choose embedded playback and visibility.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">
        <label class="chip"><input id="ytEmbedded" type="checkbox" checked> Play inside app (embedded)</label>
        <label class="chip"><input id="ytShow" type="checkbox"> Show Video</label>
        <label class="chip"><input id="ytShuffle" type="checkbox" checked> Shuffle</label>
        <label class="chip"><input id="ytNextOnStart" type="checkbox" checked> Next track on T2 start</label>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="ytNextVideo" class="btn">â­ï¸ Next Video</button>
        <button id="ytNextChapter" class="btn">â© Next Chapter</button>
      </div>
    </div>

    <h2>Playlist Manager (YouTube) â€” 30 entries</h2>
    <div class="block" id="pmBlock">
      <div id="pmRows"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button id="pmAdd" class="btn">âž• Add entry</button>
        <button id="pmSave" class="btn">ðŸ’¾ Save JSON</button>
        <input id="pmLoadFile" type="file" accept="application/json" hidden>
        <button id="pmLoad" class="btn">ðŸ“‚ Load JSON</button>
      </div>
    </div>

    <div class="row">
      <button id="closeSettings" class="btn btn-xxl">â†©ï¸ Back</button>
    </div>
  </div>
</div>

<div id="ytFloat">
  <div id="ytFloatHeader"><span>YouTube</span><button id="ytClose" class="btn small">âœ•</button></div>
  <div id="ytFloatBody"><div id="ytPlayer"></div></div>
</div>

<div id="lockOverlay" class="lock-overlay"></div>
<div id="lockMsg" class="lock-msg">ðŸ”’ Screen locked â€” double tap to unlock</div>

<div class="footer">v17</div>
<div class="transient" id="splashMsg">Jimmy James â€“ 05.10.2025</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const pad=n=>String(n).padStart(2,'0');
  const fmt=secs=>{secs=Math.max(0,Math.round(secs));const m=Math.floor(secs/60),s=secs%60;return pad(m)+':'+pad(s)};

  const state={
    t:[30,20,0,0],
    i:0, running:false, startTs:0, elapsed:0,
    swElapsed:0, swLastStart:0,
    sp:{token:null, timers:[true,false,false,false]},
    yt:{embedded:true, show:false, shuffle:true, nextOnStart:true, ready:false, player:null, playlist:[], activeIndex:0, chapters:[], hiddenPlay:true},
    pm:[], pmActive:-1,
    wake:true, lock:false, dim:'off'
  };

  function save(){ localStorage.setItem('quad_v17', JSON.stringify({
    t:state.t, spT:state.sp.timers, pm:state.pm, pmActive:state.pmActive,
    yt:{embedded:state.yt.embedded, show:state.yt.show, shuffle:state.yt.shuffle, nextOnStart:state.yt.nextOnStart},
    wake:state.wake, dim:state.dim
  })); }
  (function load(){
    try{
      const v=JSON.parse(localStorage.getItem('quad_v17')||'{}');
      if(v.t) state.t=v.t;
      if(v.spT) state.sp.timers=v.spT;
      if(v.pm) state.pm=v.pm;
      if(v.pmActive!==undefined) state.pmActive=v.pmActive;
      if(v.yt){ Object.assign(state.yt, v.yt); }
      if(v.wake!==undefined) state.wake=v.wake;
      if(v.dim) state.dim=v.dim;
    }catch{}
  })();

  function updateHeader(){
    $('t1Goal').textContent=fmt(state.t[0]);
    $('t2Goal').textContent=fmt(state.t[1]);
    $('t3Goal').textContent=fmt(state.t[2]);
    $('t4Goal').textContent=fmt(state.t[3]);
  }
  function setPhaseColors(){
    document.body.classList.remove('t1','t2','t3','t4','paused','playing');
    document.body.classList.add('t'+(state.i+1));
    if(state.running) document.body.classList.add('playing'); else document.body.classList.add('paused');
  }
  function currentTotal(){ return state.t[state.i]||0; }
  function remaining(){ return Math.max(0, Math.round(currentTotal()-state.elapsed)); }
  function tickLive(){ const d=new Date(); $('liveClock').textContent=pad(d.getHours())+':'+pad(d.getMinutes()); }
  setInterval(tickLive,1000); tickLive();

  function updateStopwatch(){
    let sw=state.swElapsed;
    if(state.running && state.swLastStart) sw += (performance.now()-state.swLastStart)/1000;
    $('stopwatch').textContent=fmt(sw);
  }

  function updateProgress(){
    const total=currentTotal();
    const frac= total>0 ? Math.min(state.elapsed/total,1) : 1;
    const h=Math.max(6, frac*100);
    $('progressFull').style.height=h.toFixed(2)+'vh';
    const bar= ['#1b6ad8','#7a1111','#163a8c','#7a1111'][state.i];
    $('progressFull').style.background='linear-gradient(to top,'+bar+','+bar+')';
  }

  function updateClockUI(){
    $('clock').textContent=fmt(remaining());
    $('phase').textContent='T'+(state.i+1);
    setPhaseColors();
    updateProgress();
    updateStopwatch();
    const showNav = !state.running && !$('settings').hidden;
    $('backBtn').style.display = (!state.running)&&$('settings').hidden ? 'inline-flex' : 'none';
    $('fwdBtn').style.display  = (!state.running)&&$('settings').hidden ? 'inline-flex' : 'none';
  }

  function setPhase(idx){
    state.i=idx;
    state.elapsed=0;
    state.startTs=performance.now();
    updateClockUI();
  }

  function nextPhase(){
    let ni = (state.i+1)%4;
    // skip zero phases
    for(let k=0;k<4;k++){ if(state.t[ni]>0) break; ni=(ni+1)%4; }
    if(ni===0 && state.i===3){ /* new rep */ }
    state.i=ni; state.elapsed=0; state.startTs=performance.now();
    onPhaseStart();
    updateClockUI();
  }
  function prevPhase(){
    let ni = (state.i+3)%4;
    for(let k=0;k<4;k++){ if(state.t[ni]>0) break; ni=(ni+3)%4; }
    state.i=ni; state.elapsed=0; state.startTs=performance.now();
    updateClockUI();
  }

  let rafId=null;
  function loop(){
    if(!state.running) return;
    const now=performance.now();
    state.elapsed=Math.max(0,(now-state.startTs)/1000);
    if(state.elapsed>=currentTotal()){
      nextPhase();
    }
    updateClockUI();
    rafId=requestAnimationFrame(loop);
  }

  function start(){
    if(!(state.t.some(v=>v>0))) return;
    if(state.running) return;
    state.running=true;
    state.startTs = performance.now() - state.elapsed*1000;
    state.swLastStart = performance.now();
    document.body.classList.remove('paused'); document.body.classList.add('playing');
    hideHelp();
    onPhaseStart();
    loop();
  }
  function pause(){
    if(!state.running) return;
    state.running=false;
    if(rafId) cancelAnimationFrame(rafId), rafId=null;
    if(state.swLastStart){
      state.swElapsed += (performance.now()-state.swLastStart)/1000;
      state.swLastStart=0;
    }
    document.body.classList.add('paused'); document.body.classList.remove('playing');
    // Do not auto-resume media; leave as is
    updateClockUI();
  }
  function toggle(){ state.running?pause():start(); }

  $('timerArea').addEventListener('pointerdown',(e)=>{
    if(!$('settings').hidden) return;
    if(e.target.closest('button,input,label,#ytFloat')) return;
    toggle();
  });
  $('startBtn').onclick=toggle;
  $('backBtn').onclick=()=>{ if(!state.running) prevPhase(); };
  $('fwdBtn').onclick=()=>{ if(!state.running) nextPhase(); };

  // Settings
  function openSettings(){ pause(); $('settings').hidden=false; document.body.classList.add('in-settings'); refreshSettingsUI(); }
  function closeSettings(){ $('settings').hidden=true; document.body.classList.remove('in-settings'); updateClockUI(); }
  $('openSettings').onclick=openSettings;
  $('closeSettings').onclick=closeSettings;

  function refreshSettingsUI(){
    $('t1Input').value=state.t[0]; $('t2Input').value=state.t[1]; $('t3Input').value=state.t[2]; $('t4Input').value=state.t[3];
    $('wakeToggle').checked=state.wake;
    $('lockToggle').checked=state.lock;
    document.querySelectorAll('input[name="dim"]').forEach(r=>{ r.checked = (r.value===state.dim); });
    $('spT1').checked=state.sp.timers[0]; $('spT2').checked=state.sp.timers[1]; $('spT3').checked=state.sp.timers[2]; $('spT4').checked=state.sp.timers[3];
    $('ytEmbedded').checked=state.yt.embedded; $('ytShow').checked=state.yt.show; $('ytShuffle').checked=state.yt.shuffle; $('ytNextOnStart').checked=state.yt.nextOnStart;
    $('ytFloat').style.display = (state.yt.embedded && state.yt.show) ? 'block' : 'none';
  }

  $('t1Input').oninput=()=>{ state.t[0]=Math.max(0,parseInt($('t1Input').value||'0')); save(); updateHeader(); updateClockUI(); };
  $('t2Input').oninput=()=>{ state.t[1]=Math.max(0,parseInt($('t2Input').value||'0')); save(); updateHeader(); updateClockUI(); };
  $('t3Input').oninput=()=>{ state.t[2]=Math.max(0,parseInt($('t3Input').value||'0')); save(); updateHeader(); updateClockUI(); };
  $('t4Input').oninput=()=>{ state.t[3]=Math.max(0,parseInt($('t4Input').value||'0')); save(); updateHeader(); updateClockUI(); };

  $('wakeToggle').onchange=()=>{ state.wake=$('wakeToggle').checked; save(); applyWakeLock(); };
  $('lockToggle').onchange=()=>{ state.lock=$('lockToggle').checked; save(); applyLock(); };
  document.querySelectorAll('input[name="dim"]').forEach(r=>r.onchange=()=>{ state.dim=document.querySelector('input[name="dim"]:checked').value; save(); applyLock(); });

  $('spT1').onchange=()=>{ state.sp.timers[0]=$('spT1').checked; save(); };
  $('spT2').onchange=()=>{ state.sp.timers[1]=$('spT2').checked; save(); };
  $('spT3').onchange=()=>{ state.sp.timers[2]=$('spT3').checked; save(); };
  $('spT4').onchange=()=>{ state.sp.timers[3]=$('spT4').checked; save(); };

  $('ytEmbedded').onchange=()=>{ state.yt.embedded=$('ytEmbedded').checked; save(); syncYouTubeVisibility(); };
  $('ytShow').onchange=()=>{ state.yt.show=$('ytShow').checked; save(); syncYouTubeVisibility(); };
  $('ytShuffle').onchange=()=>{ state.yt.shuffle=$('ytShuffle').checked; save(); };
  $('ytNextOnStart').onchange=()=>{ state.yt.nextOnStart=$('ytNextOnStart').checked; save(); };

  // Help (only when paused)
  function showHelp(){ $('helpCard').style.display='block'; }
  function hideHelp(){ $('helpCard').style.display='none'; }
  $('helpBtn').onclick=()=>{ if(!state.running) { const v=$('helpCard').style.display!=='block'; if(v) showHelp(); else hideHelp(); } };

  // Wake Lock
  let wakeLock=null;
  async function applyWakeLock(){
    if('wakeLock' in navigator){
      try{
        if(state.wake){
          if(!wakeLock){ wakeLock=await navigator.wakeLock.request('screen'); }
        }else{
          if(wakeLock){ await wakeLock.release(); wakeLock=null; }
        }
      }catch(e){}
    }
  }
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') applyWakeLock(); });
  applyWakeLock();

  // Lock screen
  let lastTap=0;
  function applyLock(){
    const ov=$('lockOverlay'), msg=$('lockMsg');
    if(state.lock){
      ov.className='lock-overlay';
      if(state.dim==='60') ov.classList.add('dim60');
      if(state.dim==='80') ov.classList.add('dim80');
      if(state.dim==='100') ov.classList.add('dim100');
      ov.style.display='block'; msg.style.display='block';
    }else{
      ov.style.display='none'; msg.style.display='none';
    }
  }
  $('lockOverlay').addEventListener('touchstart',onLockTap);
  $('lockOverlay').addEventListener('pointerdown',onLockTap);
  function onLockTap(){
    const now=Date.now();
    if(now-lastTap<300){ state.lock=false; save(); applyLock(); }
    lastTap=now;
  }

  // Splash
  (function splash(){
    const el=$('splashMsg'); el.classList.add('show');
    setTimeout(()=>{ el.classList.remove('show'); el.style.display='none'; }, 5000);
  })();

  // Stopwatch tick
  setInterval(updateStopwatch, 500);

  // YouTube IFrame API
  let ytAPIReady=false;
  window.onYouTubeIframeAPIReady=function(){ ytAPIReady=true; initYT(); };
  const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.head.appendChild(tag);

  function initYT(){
    if(!ytAPIReady) return;
    state.yt.player = new YT.Player('ytPlayer',{
      height:'100%', width:'100%',
      playerVars:{'playsinline':1,'autoplay':0,'controls':1,'origin':location.origin},
      events:{
        'onReady':()=>{ state.yt.ready=true; if(state.pmActive>=0) cueYTFromActive(); },
        'onStateChange':onYTState
      }
    });
    syncYouTubeVisibility();
  }
  function onYTState(e){
    // optionally parse chapters when playing
    if(e.data===YT.PlayerState.PLAYING){
      // try to read chapters from cues if available (not guaranteed)
    }
  }

  function syncYouTubeVisibility(){
    $('ytFloat').style.display = (state.yt.embedded && state.yt.show) ? 'block' : 'none';
    if(!state.yt.embedded){
      $('ytFloat').style.display='none';
    }
  }
  $('ytClose').onclick=()=>{ state.yt.show=false; $('ytShow').checked=false; save(); syncYouTubeVisibility(); };

  function cueYT(url){
    if(!state.yt.player) return;
    try{
      const u=new URL(url);
      if(u.searchParams.get('list')){
        const list=u.searchParams.get('list');
        state.yt.player.loadPlaylist({list:list,listType:'playlist',index:0});
        if(state.yt.shuffle) state.yt.player.setShuffle(true);
      }else{
        const vid = u.searchParams.get('v') || u.pathname.replace('/watch','').replace('/','');
        state.yt.player.loadVideoById(vid);
      }
    }catch{}
  }

  $('ytNextVideo').onclick=()=>{ if(state.yt.player&&state.yt.ready){ try{ state.yt.player.nextVideo(); }catch{} } };
  $('ytNextChapter').onclick=()=>{
    if(!state.yt.player||!state.yt.ready) return;
    try{
      const d=state.yt.player.getDuration();
      const t=state.yt.player.getCurrentTime();
      // heuristic: jump +60s if chapters unknown
      state.yt.player.seekTo(Math.min(d, t+60), true);
    }catch{}
  };

  function onPhaseStart(){
    // YouTube control on T2 by default
    if(state.i===1){
      if(state.yt.embedded && state.pmActive>=0){
        if(state.yt.nextOnStart && state.yt.player && state.yt.ready){
          try{ state.yt.player.nextVideo(); }catch{}
        }else{
          if(state.yt.player && state.yt.ready){
            try{ state.yt.player.playVideo(); }catch{}
          }
        }
      }else if(state.yt.embedded && state.pmActive<0){
        // cue default playlist once if none
        if(state.pm.length===0){
          state.pm.push({label:'Default',url:'https://youtube.com/playlist?list=PLj_R-xNx8BKj87kBY7bzCsp7Hcvjj-jRt',active:true});
          state.pmActive=0; save(); buildPM();
        }
        cueYT(state.pm[state.pmActive].url);
        if(state.yt.player && state.yt.ready) try{ state.yt.player.playVideo(); }catch{}
      }
    }else{
      // not T2
      if(state.yt.player && state.yt.ready){
        try{ state.yt.player.pauseVideo(); }catch{}
      }
    }
    // Spotify control based on selection
    const spShouldPlay = state.sp.timers[state.i]===true;
    if(spShouldPlay) spPlay().catch(()=>{}); else spPause().catch(()=>{});
  }

  // Playlist Manager
  function buildPM(){
    const rows=$('pmRows'); rows.innerHTML='';
    for(let i=0;i<state.pm.length;i++){
      const it=state.pm[i];
      const row=document.createElement('div'); row.className='pm-row';
      const lab=document.createElement('input'); lab.type='text'; lab.value=it.label||''; lab.placeholder='Label';
      const url=document.createElement('input'); url.type='url'; url.value=it.url||''; url.placeholder='YouTube playlist or video URL';
      const use=document.createElement('button'); use.className='use-btn'+(i===state.pmActive?' active':'');
      use.textContent = (i===state.pmActive)?'Using':'Use';
      const clr=document.createElement('button'); clr.className='clear-btn'; clr.textContent='Clear';
      row.appendChild(lab); row.appendChild(url); row.appendChild(use); row.appendChild(clr);
      rows.appendChild(row);
      lab.oninput=()=>{ it.label=lab.value; save(); };
      url.oninput=()=>{ it.url=url.value; save(); };
      use.onclick=()=>{
        state.pmActive=i;
        Array.from(rows.querySelectorAll('.use-btn')).forEach((b,idx)=>{ b.classList.toggle('active', idx===i); b.textContent = (idx===i)?'Using':'Use'; });
        save();
        if(state.yt.player && state.yt.ready && it.url){ cueYT(it.url); if(state.i===1) try{ state.yt.player.playVideo(); }catch{} }
      };
      clr.onclick=()=>{ it.label=''; it.url=''; if(state.pmActive===i) state.pmActive=-1; save(); buildPM(); };
    }
  }
  $('pmAdd').onclick=()=>{
    if(state.pm.length>=30) return;
    state.pm.push({label:'',url:'',active:false}); save(); buildPM();
  };
  $('pmSave').onclick=()=>{
    const blob=new Blob([JSON.stringify({pm:state.pm,active:state.pmActive},null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='playlists_v17.json'; a.click();
  };
  $('pmLoad').onclick=()=>{ $('pmLoadFile').click(); };
  $('pmLoadFile').onchange=(e)=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{
      try{ const j=JSON.parse(r.result); if(j.pm){ state.pm=j.pm; state.pmActive=j.active??-1; save(); buildPM(); } }catch{}
    }; r.readAsText(f);
  };

  // Default playlist if none
  if(state.pm.length===0){
    state.pm=[{label:'Default',url:'https://youtube.com/playlist?list=PLj_R-xNx8BKj87kBY7bzCsp7Hcvjj-jRt',active:true}];
    state.pmActive=0;
  }
  buildPM();

  // Spotify
  function spAuthUrl(){
    const cid='f9cc60b0273d4997992022c01c2f743f';
    const red=encodeURIComponent('https://jimmez.github.io/quad/');
    const scope=encodeURIComponent('streaming user-read-playback-state user-modify-playback-state');
    return 'https://accounts.spotify.com/authorize?client_id='+cid+'&response_type=token&redirect_uri='+red+'&scope='+scope+'&show_dialog=true';
  }
  function parseHashToken(){
    if(location.hash.includes('access_token=')){
      const m=location.hash.substring(1).split('&').map(s=>s.split('=')); const map=Object.fromEntries(m);
      if(map.access_token){ state.sp.token=map.access_token; localStorage.setItem('sp_token',state.sp.token); history.replaceState(null,'',location.pathname+location.search); }
    }else{
      const t=localStorage.getItem('sp_token'); if(t) state.sp.token=t;
    }
  }
  parseHashToken();
  $('spConnect').onclick=()=>{ location.href=spAuthUrl(); };

  async function spFetch(endpoint, method='GET', body){
    if(!state.sp.token) return Promise.reject('no token');
    const res=await fetch('https://api.spotify.com/v1/'+endpoint,{
      method, headers:{'Authorization':'Bearer '+state.sp.token,'Content-Type':'application/json'},
      body: body?JSON.stringify(body):undefined
    });
    if(res.status===204) return null;
    if(!res.ok) throw new Error('Spotify '+res.status);
    return res.json();
  }
  async function spPause(){ try{ await spFetch('me/player/pause','PUT'); }catch(e){} }
  async function spPlay(){ try{ await spFetch('me/player/play','PUT'); }catch(e){} }

  // YT autoplay on T2 start; pause does not auto-resume
  function cueYTFromActive(){
    if(state.pmActive>=0 && state.pm[state.pmActive].url){
      cueYT(state.pm[state.pmActive].url);
    }
  }

  // Draggable YT float
  (function draggable(){
    const box=$('ytFloat'); let sx=0, sy=0, bx=0, by=0, dragging=false;
    $('ytFloatHeader').addEventListener('pointerdown',(e)=>{
      dragging=true; sx=e.clientX; sy=e.clientY; const r=box.getBoundingClientRect(); bx=r.left; by=r.top; box.setPointerCapture(e.pointerId);
    });
    window.addEventListener('pointermove',(e)=>{
      if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; box.style.left=(bx+dx)+'px'; box.style.top=(by+dy)+'px'; box.style.right='auto'; box.style.bottom='auto';
    });
    window.addEventListener('pointerup',()=>{ dragging=false; });
  })();

  // Show/Hide YouTube float initially based on settings
  syncYouTubeVisibility();

  // Initial draw
  updateHeader();
  $('clock').textContent=fmt(state.t[0]);
  updateClockUI();

  // Start in paused
  pause();

  // Show splash
  // already handled above
})();
</script>
</body>
</html>
